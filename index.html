<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Bible Round Table – Realtime Test</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: #020617;
      color: #e5e7eb;
      margin: 0;
      padding: 1rem;
    }
    h1 { margin-top: 0; }
    .panel {
      max-width: 900px;
      margin: 0 auto;
      background: #020617;
      border-radius: 12px;
      border: 1px solid #334155;
      padding: 1rem 1.25rem;
      box-shadow: 0 20px 50px rgba(0,0,0,0.7);
    }
    input, button {
      font: inherit;
    }
    input[type="text"] {
      padding: 0.4rem 0.5rem;
      border-radius: 999px;
      border: 1px solid #475569;
      background: #020617;
      color: #e5e7eb;
      width: 100%;
      max-width: 260px;
    }
    button {
      margin-top: 0.4rem;
      padding: 0.4rem 0.8rem;
      border-radius: 999px;
      border: none;
      background: #f97316;
      color: #020617;
      cursor: pointer;
      font-weight: 600;
    }
    button.secondary {
      background: #1e293b;
      color: #e5e7eb;
    }
    .row {
      display: flex;
      gap: 1rem;
      flex-wrap: wrap;
      margin-top: 0.75rem;
    }
    .box {
      flex: 1 1 260px;
      border-radius: 10px;
      border: 1px solid #1f2937;
      padding: 0.75rem;
      background: #020617;
    }
    .label {
      font-size: 0.8rem;
      color: #9ca3af;
      margin-bottom: 0.15rem;
    }
    .mono {
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size: 0.85rem;
      word-break: break-all;
    }
    .field {
      margin-bottom: 0.5rem;
    }
    .section-title {
      font-size: 0.9rem;
      font-weight: 600;
      margin-bottom: 0.25rem;
    }
    #log {
      font-size: 0.78rem;
      white-space: pre-wrap;
      max-height: 200px;
      overflow-y: auto;
      border-radius: 8px;
      border: 1px solid #1f2937;
      padding: 0.5rem;
      background: #020617;
    }
    #question, #verseRef, #verseText {
      margin: 0.15rem 0;
    }
  </style>
</head>
<body>
  <div class="panel">
    <h1>Bible Round Table – Realtime Test</h1>
    <p style="font-size:0.9rem;color:#9ca3af">
      This page tests the full pipeline: Google Sheets → Apps Script → Firebase → multiple browsers.
      <br>Use one browser to <strong>Create Game</strong>, then another to <strong>Join</strong> with the same Game ID.
    </p>

    <div class="row">
      <div class="box">
        <div class="section-title">1. Player Info</div>
        <div class="field">
          <div class="label">First name</div>
          <input type="text" id="firstName" placeholder="e.g. John">
        </div>
        <div class="field">
          <div class="label">Last name</div>
          <input type="text" id="lastName" placeholder="e.g. Kim">
        </div>
      </div>

      <div class="box">
        <div class="section-title">2. Create Game (become Admin)</div>
        <div class="field">
          <div class="label">Sheets API URL (Apps Script Web App)</div>
          <input type="text" id="scriptUrl" placeholder="https://script.google.com/macros/s/AKfycbzOy5BJ9VbqUlujW2Hg4BbJM6KNdeM_LMjq5EHtafPDPuJI34NAEmDzxgbkvrSHkiPp/exec">
        </div>
        <button id="btnCreate">Create Game</button>
        <div class="field" style="margin-top:0.5rem">
          <div class="label">Created Game ID</div>
          <div class="mono" id="createdGameId">–</div>
        </div>
      </div>

      <div class="box">
        <div class="section-title">3. Join Existing Game</div>
        <div class="field">
          <div class="label">Game ID</div>
          <input type="text" id="joinGameId" placeholder="Paste Game ID">
        </div>
        <button class="secondary" id="btnJoin">Join Game</button>
        <div class="field" style="margin-top:0.5rem">
          <div class="label">Current Connection</div>
          <div class="mono" id="status">Not connected</div>
        </div>
      </div>
    </div>

    <hr style="margin:1rem 0;border:0;border-top:1px solid #1f2937;">

    <div class="row">
      <div class="box">
        <div class="section-title">Shared Game State (first question)</div>
        <div class="label">Game ID</div>
        <div class="mono" id="currentGameId">–</div>

        <div class="label" style="margin-top:0.4rem">Verse reference</div>
        <div id="verseRef">–</div>

        <div class="label" style="margin-top:0.4rem">Verse text</div>
        <div id="verseText">–</div>

        <div class="label" style="margin-top:0.4rem">Question</div>
        <div id="question">–</div>
      </div>

      <div class="box">
        <div class="section-title">Debug Log</div>
        <div id="log"></div>
      </div>
    </div>
  </div>

  <!-- Firebase + app logic -->
  <script type="module">
    /************************************************
     * 1) Firebase setup – paste your config here
     ************************************************/
    const firebaseConfig = {
      apiKey: "AIzaSyAvowntn96MSlL3Stxqh-gUUGEpAnJT6uo",
      authDomain: "christian-roundtable.firebaseapp.com",
      projectId: "christian-roundtable",
      storageBucket: "christian-roundtable.firebasestorage.app",
      messagingSenderId: "981074913898",
      appId: "1:981074913898:web:52183899c18e5cd0aff813",
      measurementId: "G-JT29F5HZGE"
    };

    // Import Firebase modules from CDN (modular v9+)
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
    import {
      getFirestore,
      collection,
      doc,
      addDoc,
      setDoc,
      getDoc,
      onSnapshot,
      serverTimestamp
    } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore.js";

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    /************************************************
     * 2) Small helpers
     ************************************************/
    function log(msg) {
      const el = document.getElementById('log');
      el.textContent += msg + "\n";
      el.scrollTop = el.scrollHeight;
    }

    function getPlayerName() {
      const f = document.getElementById('firstName').value.trim() || "Anon";
      const l = document.getElementById('lastName').value.trim() || "Player";
      return { firstName: f, lastName: l };
    }

    let currentGameDocRef = null;
    let unsubscribeGame = null;

    /************************************************
     * 3) Create Game – fetch questions from Sheets,
     *    store the list in Firestore
     ************************************************/
    async function handleCreate() {
      const scriptUrl = document.getElementById('scriptUrl').value.trim();
      if (!scriptUrl) {
        alert("Enter your Apps Script Web App URL first.");
        return;
      }

      const { firstName, lastName } = getPlayerName();
      log("Creating game as " + firstName + " " + lastName + "...");

      // 1) Fetch questions from Apps Script API
      try {
        const res = await fetch(scriptUrl + "?action=getQuestions");
        if (!res.ok) throw new Error("HTTP " + res.status);
        const questions = await res.json();
        log("Loaded " + questions.length + " questions from Sheets.");

        if (!Array.isArray(questions) || questions.length === 0) {
          alert("No questions returned from Sheets.");
          return;
        }

        // 2) Create a game doc in Firestore
        const gamesCol = collection(db, "games");
        const gameDoc = await addDoc(gamesCol, {
          createdAt: serverTimestamp(),
          status: "lobby",
          adminName: firstName + " " + lastName,
          currentQuestionIndex: 0,
          questions: questions   // store whole list for now
        });

        const gameId = gameDoc.id;
        document.getElementById('createdGameId').textContent = gameId;
        document.getElementById('joinGameId').value = gameId;
        document.getElementById('status').textContent = "Created game " + gameId;
        log("Game created with ID: " + gameId);

        subscribeToGame(gameId);
      } catch (err) {
        console.error(err);
        log("Error creating game: " + err.message);
        alert("Error creating game; see log.");
      }
    }

    /************************************************
     * 4) Join existing game
     ************************************************/
    async function handleJoin() {
      const gameId = document.getElementById('joinGameId').value.trim();
      if (!gameId) {
        alert("Enter a Game ID to join.");
        return;
      }
      subscribeToGame(gameId);
    }

    /************************************************
     * 5) Subscribe in realtime to a game document
     ************************************************/
    function subscribeToGame(gameId) {
      if (unsubscribeGame) {
        unsubscribeGame();
        unsubscribeGame = null;
      }

      const gameRef = doc(db, "games", gameId);
      currentGameDocRef = gameRef;
      document.getElementById('currentGameId').textContent = gameId;
      document.getElementById('status').textContent = "Connecting to game " + gameId + "...";

      unsubscribeGame = onSnapshot(gameRef, (snap) => {
        if (!snap.exists()) {
          document.getElementById('status').textContent = "Game not found.";
          log("Game " + gameId + " does not exist.");
          return;
        }
        const data = snap.data();
        document.getElementById('status').textContent = "Connected to game " + gameId;

        const idx = data.currentQuestionIndex || 0;
        const qList = data.questions || [];
        const q = qList[idx] || null;

        if (q) {
          document.getElementById('verseRef').textContent = q.verseRef || "–";
          document.getElementById('verseText').textContent = q.verseText || "–";
          document.getElementById('question').textContent = q.question || "–";
          log("Showing question #" + (idx + 1) + " (" + (q.id || "no id") + ")");
        } else {
          document.getElementById('verseRef').textContent = "–";
          document.getElementById('verseText').textContent = "–";
          document.getElementById('question').textContent = "No question at this index.";
          log("No question at index " + idx);
        }
      }, (err) => {
        console.error(err);
        document.getElementById('status').textContent = "Error listening to game.";
        log("onSnapshot error: " + err.message);
      });
    }

    /************************************************
     * 6) Wire up buttons
     ************************************************/
    document.getElementById('btnCreate').addEventListener('click', handleCreate);
    document.getElementById('btnJoin').addEventListener('click', handleJoin);
  </script>
</body>
</html>
